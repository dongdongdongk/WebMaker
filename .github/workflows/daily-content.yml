name: Daily Content Generation

on:
  schedule:
    # ë§¤ì¼ UTC 02:00 (í•œêµ­ì‹œê°„ 11:00)ì— ì‹¤í–‰
    - cron: '0 2 * * *'
  workflow_dispatch:
    # ìˆ˜ë™ ì‹¤í–‰ë„ ê°€ëŠ¥
    inputs:
      skip_keyword_collection:
        description: 'í‚¤ì›Œë“œ ìˆ˜ì§‘ ê±´ë„ˆë›°ê¸°'
        required: false
        default: 'false'
        type: boolean
      skip_crawling:
        description: 'ì½˜í…ì¸  í¬ë¡¤ë§ ê±´ë„ˆë›°ê¸°'
        required: false
        default: 'false'
        type: boolean
      post_count:
        description: 'ìƒì„±í•  í¬ìŠ¤íŠ¸ ìˆ˜'
        required: false
        default: '1'
        type: string

env:
  # GitHub Secretsì—ì„œ í™˜ê²½ë³€ìˆ˜ ë¡œë“œ
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
  GOOGLE_TRENDS_API_KEY: ${{ secrets.GOOGLE_TRENDS_API_KEY }}
  NEWS_API_KEY: ${{ secrets.NEWS_API_KEY }}
  GNEWS_API_KEY: ${{ secrets.GNEWS_API_KEY }}
  REDDIT_CLIENT_ID: ${{ secrets.REDDIT_CLIENT_ID }}
  REDDIT_CLIENT_SECRET: ${{ secrets.REDDIT_CLIENT_SECRET }}
  GMAIL_USER: ${{ secrets.GMAIL_USER }}
  GMAIL_PASSWORD: ${{ secrets.GMAIL_PASSWORD }}
  NOTIFICATION_EMAIL: ${{ secrets.NOTIFICATION_EMAIL }}
  NODE_ENV: production

jobs:
  content-generation:
    runs-on: ubuntu-latest
    timeout-minutes: 25  # 25ë¶„ ì œí•œ (ìµœì í™”ëœ ì‹œê°„)

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Node.js í™˜ê²½ ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ì˜ì¡´ì„± ìºì‹œ í™•ì¸
        id: cache-deps
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: ì˜ì¡´ì„± ì„¤ì¹˜ (ìºì‹œ ë¯¸ìŠ¤ ì‹œì—ë§Œ)
        if: steps.cache-deps.outputs.cache-hit != 'true'
        run: |
          npm ci --silent --prefer-offline
          npm run build --if-present

      - name: ìºì‹œëœ ì˜ì¡´ì„± í™•ì¸
        if: steps.cache-deps.outputs.cache-hit == 'true'
        run: |
          echo "âœ… ìºì‹œëœ ì˜ì¡´ì„± ì‚¬ìš© - ì„¤ì¹˜ ì‹œê°„ ë‹¨ì¶•"
          ls -la node_modules | head -5

      - name: Git ì‚¬ìš©ì ì„¤ì •
        run: |
          git config --global user.name "WebMaker AI Bot"
          git config --global user.email "noreply@webmaker.ai"

      - name: í™˜ê²½ë³€ìˆ˜ ê²€ì¦
        run: |
          echo "í™˜ê²½ë³€ìˆ˜ ê²€ì¦ ì¤‘..."
          [ -n "$OPENAI_API_KEY" ] && echo "âœ… OpenAI API í‚¤ ì„¤ì •ë¨" || echo "âš ï¸ OpenAI API í‚¤ ì—†ìŒ"
          [ -n "$NEWS_API_KEY" ] && echo "âœ… News API í‚¤ ì„¤ì •ë¨" || echo "âš ï¸ News API í‚¤ ì—†ìŒ"
          [ -n "$GMAIL_USER" ] && echo "âœ… Gmail ì„¤ì •ë¨" || echo "âš ï¸ Gmail ì„¤ì • ì—†ìŒ"
          echo "ì‘ì—… ì‹œì‘ ì‹œê°„: $(date)"

      # Step 1-2: í‚¤ì›Œë“œ ìˆ˜ì§‘ê³¼ í¬ë¡¤ë§ ë³‘ë ¬ ì‹¤í–‰ (ì‹œê°„ ë‹¨ì¶•)
      - name: "Step 1: í‚¤ì›Œë“œ ìˆ˜ì§‘"
        if: ${{ !inputs.skip_keyword_collection }}
        id: keywords
        run: |
          echo "ğŸ” í‚¤ì›Œë“œ ìˆ˜ì§‘ ì‹œì‘..."
          node scripts/collect-keywords-refactored.js &
          KEYWORDS_PID=$!
          
          # í‚¤ì›Œë“œ ìˆ˜ì§‘ ì™„ë£Œ ëŒ€ê¸°
          wait $KEYWORDS_PID
          
          # ê²°ê³¼ ê²€ì¦
          if [ -f "config/keywords-today.json" ]; then
            KEYWORD_COUNT=$(cat config/keywords-today.json | jq '.finalKeywords | length // 0')
            echo "keyword_count=$KEYWORD_COUNT" >> $GITHUB_OUTPUT
            echo "âœ… í‚¤ì›Œë“œ $KEYWORD_COUNTê°œ ìˆ˜ì§‘ ì™„ë£Œ"
          else
            echo "âš ï¸ í‚¤ì›Œë“œ íŒŒì¼ ìƒì„± ì‹¤íŒ¨ - ê¸°ë³¸ í‚¤ì›Œë“œ ì‚¬ìš©"
            echo "keyword_count=0" >> $GITHUB_OUTPUT
          fi

      # Step 2: ì½˜í…ì¸  í¬ë¡¤ë§ (í‚¤ì›Œë“œ ìˆ˜ì§‘ ì§í›„)
      - name: "Step 2: ì½˜í…ì¸  í¬ë¡¤ë§"
        if: ${{ !inputs.skip_crawling && always() }}
        id: crawling
        run: |
          echo "ğŸ•·ï¸ ì›¹ í¬ë¡¤ë§ ì‹œì‘..."
          
          # íƒ€ì„ì•„ì›ƒ ì„¤ì • (5ë¶„ ì œí•œ)
          timeout 300s node scripts/crawl-content-refactored.js || {
            echo "âš ï¸ í¬ë¡¤ë§ íƒ€ì„ì•„ì›ƒ - í´ë°± ë°ì´í„° ì‚¬ìš©"
            echo "content_count=0" >> $GITHUB_OUTPUT
            exit 0
          }
          
          # ê²°ê³¼ ê²€ì¦
          if [ -f "config/content-data.json" ]; then
            CONTENT_COUNT=$(cat config/content-data.json | jq '.processedContent | length // 0')
            echo "content_count=$CONTENT_COUNT" >> $GITHUB_OUTPUT
            echo "âœ… ì½˜í…ì¸  $CONTENT_COUNTê°œ í¬ë¡¤ë§ ì™„ë£Œ"
          else
            echo "âš ï¸ ì½˜í…ì¸  íŒŒì¼ ìƒì„± ì‹¤íŒ¨ - í´ë°± ë°ì´í„° ì‚¬ìš©"
            echo "content_count=0" >> $GITHUB_OUTPUT
          fi

      # Step 3: ë¸”ë¡œê·¸ í¬ìŠ¤íŠ¸ ìƒì„± (15ë¶„ ì˜ˆìƒ)
      - name: "Step 3: ë¸”ë¡œê·¸ í¬ìŠ¤íŠ¸ ìƒì„±"
        id: generation
        run: |
          echo "âœï¸ ë¸”ë¡œê·¸ í¬ìŠ¤íŠ¸ ìƒì„± ì‹œì‘..."
          
          POST_COUNT="${{ inputs.post_count || '1' }}"
          GENERATED_FILES=""
          
          for i in $(seq 1 $POST_COUNT); do
            echo "í¬ìŠ¤íŠ¸ $i/$POST_COUNT ìƒì„± ì¤‘..."
            
            if OUTPUT=$(node scripts/generate-post-refactored.js 2>&1); then
              echo "âœ… í¬ìŠ¤íŠ¸ $i ìƒì„± ì„±ê³µ"
              # ìƒì„±ëœ íŒŒì¼ ê²½ë¡œ ì¶”ì¶œ
              if echo "$OUTPUT" | grep -q "filename"; then
                FILENAME=$(echo "$OUTPUT" | grep "filename" | tail -1 | sed 's/.*filename[^:]*: *"\([^"]*\)".*/\1/')
                GENERATED_FILES="$GENERATED_FILES content/posts/$FILENAME"
              fi
            else
              echo "âŒ í¬ìŠ¤íŠ¸ $i ìƒì„± ì‹¤íŒ¨: $OUTPUT"
            fi
            
            # í¬ìŠ¤íŠ¸ ê°„ ê°„ê²©
            [ $i -lt $POST_COUNT ] && sleep 30
          done
          
          echo "generated_files=$GENERATED_FILES" >> $GITHUB_OUTPUT
          echo "post_count=$POST_COUNT" >> $GITHUB_OUTPUT

      # Step 4: SEO ìµœì í™” (ì„ íƒì‚¬í•­)
      - name: "Step 4: SEO ìµœì í™”"
        if: ${{ always() && steps.generation.outputs.generated_files }}
        run: |
          echo "ğŸ” SEO ìµœì í™” ì‹œì‘..."
          # SEO ìŠ¤í¬ë¦½íŠ¸ê°€ ìˆë‹¤ë©´ ì‹¤í–‰
          if [ -f "scripts/optimize-seo.js" ]; then
            node scripts/optimize-seo.js
            echo "âœ… SEO ìµœì í™” ì™„ë£Œ"
          else
            echo "â„¹ï¸ SEO ìµœì í™” ìŠ¤í¬ë¦½íŠ¸ ì—†ìŒ - ê±´ë„ˆë›°ê¸°"
          fi

      # Step 5: ë³€ê²½ì‚¬í•­ ì»¤ë°‹
      - name: "Step 5: ë³€ê²½ì‚¬í•­ ì»¤ë°‹"
        if: ${{ always() && steps.generation.outputs.generated_files }}
        run: |
          echo "ğŸ“ ë³€ê²½ì‚¬í•­ ì»¤ë°‹ ì¤‘..."
          
          # ë³€ê²½ëœ íŒŒì¼ í™•ì¸
          git add .
          
          if git diff --cached --quiet; then
            echo "â„¹ï¸ ì»¤ë°‹í•  ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤"
          else
            # ì»¤ë°‹ ë©”ì‹œì§€ ìƒì„±
            COMMIT_MSG="ğŸ¤– Daily Content: $(date '+%Y-%m-%d') ìë™ í¬ìŠ¤íŠ¸ ìƒì„±

ğŸ“Š ìƒì„± ê²°ê³¼:
- í‚¤ì›Œë“œ: ${{ steps.keywords.outputs.keyword_count }}ê°œ
- í¬ë¡¤ë§: ${{ steps.crawling.outputs.content_count }}ê°œ
- í¬ìŠ¤íŠ¸: ${{ steps.generation.outputs.post_count }}ê°œ

ğŸ¤– Generated with WebMaker AI
Co-Authored-By: WebMaker AI <noreply@webmaker.ai>"

            git commit -m "$COMMIT_MSG"
            git push origin main
            
            echo "âœ… ë³€ê²½ì‚¬í•­ ì»¤ë°‹ ë° í‘¸ì‹œ ì™„ë£Œ"
          fi

      # Step 6: ê²°ê³¼ ìš”ì•½
      - name: "Step 6: ì‹¤í–‰ ê²°ê³¼ ìš”ì•½"
        if: always()
        run: |
          echo "
          ## ğŸ“Š Daily Content Generation ì‹¤í–‰ ê²°ê³¼
          
          **ì‹¤í–‰ ì‹œê°„**: $(date)
          **í‚¤ì›Œë“œ ìˆ˜ì§‘**: ${{ steps.keywords.outputs.keyword_count || 'ê±´ë„ˆëœ€' }}ê°œ
          **ì½˜í…ì¸  í¬ë¡¤ë§**: ${{ steps.crawling.outputs.content_count || 'ê±´ë„ˆëœ€' }}ê°œ  
          **í¬ìŠ¤íŠ¸ ìƒì„±**: ${{ steps.generation.outputs.post_count || '0' }}ê°œ
          
          **ìƒì„±ëœ íŒŒì¼**:
          ${{ steps.generation.outputs.generated_files || 'ì—†ìŒ' }}
          
          **ìƒíƒœ**: 
          - í‚¤ì›Œë“œ ìˆ˜ì§‘: ${{ steps.keywords.conclusion || 'ê±´ë„ˆëœ€' }}
          - í¬ë¡¤ë§: ${{ steps.crawling.conclusion || 'ê±´ë„ˆëœ€' }}
          - í¬ìŠ¤íŠ¸ ìƒì„±: ${{ steps.generation.conclusion || 'ì‹¤í–‰ë¨' }}
          " | tee workflow_summary.txt

      # Step 7: ì´ë©”ì¼ ì•Œë¦¼ ë°œì†¡
      - name: "Step 7: ì´ë©”ì¼ ì•Œë¦¼"
        if: always()
        run: |
          echo "ğŸ“§ ì´ë©”ì¼ ì•Œë¦¼ ë°œì†¡ ì¤‘..."
          
          # ì´ë©”ì¼ ìŠ¤í¬ë¦½íŠ¸ê°€ ìˆë‹¤ë©´ ì‹¤í–‰
          if [ -f "scripts/send-email.js" ]; then
            # ì›Œí¬í”Œë¡œìš° ìƒíƒœë¥¼ í™˜ê²½ë³€ìˆ˜ë¡œ ì „ë‹¬
            export WORKFLOW_STATUS="${{ job.status }}"
            export KEYWORDS_COUNT="${{ steps.keywords.outputs.keyword_count || '0' }}"
            export CONTENT_COUNT="${{ steps.crawling.outputs.content_count || '0' }}"
            export POSTS_COUNT="${{ steps.generation.outputs.post_count || '0' }}"
            export GENERATED_FILES="${{ steps.generation.outputs.generated_files || '' }}"
            
            node scripts/send-email.js
            echo "âœ… ì´ë©”ì¼ ì•Œë¦¼ ë°œì†¡ ì™„ë£Œ"
          else
            echo "â„¹ï¸ ì´ë©”ì¼ ìŠ¤í¬ë¦½íŠ¸ ì—†ìŒ - ê±´ë„ˆë›°ê¸°"
          fi

      # ì˜¤ë¥˜ ë°œìƒ ì‹œ ë””ë²„ê¹… ì •ë³´ ìˆ˜ì§‘
      - name: ë””ë²„ê¹… ì •ë³´ ìˆ˜ì§‘
        if: failure()
        run: |
          echo "âŒ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ì‹¤íŒ¨ - ë””ë²„ê¹… ì •ë³´ ìˆ˜ì§‘ ì¤‘"
          echo "
          ## ë””ë²„ê¹… ì •ë³´
          
          **Node.js ë²„ì „**: $(node --version)
          **NPM ë²„ì „**: $(npm --version)
          **ì‘ì—… ë””ë ‰í† ë¦¬**: $(pwd)
          **í™˜ê²½ë³€ìˆ˜**:
          - NODE_ENV: $NODE_ENV
          - í˜„ì¬ ì‹œê°„: $(date)
          
          **íŒŒì¼ ì‹œìŠ¤í…œ ìƒíƒœ**:
          "
          ls -la
          echo "
          **ìµœê·¼ ë¡œê·¸**:
          "
          tail -20 ~/.npm/_logs/*.log 2>/dev/null || echo "NPM ë¡œê·¸ ì—†ìŒ"

  # ì •ë¦¬ ì‘ì—… (ì„ íƒì‚¬í•­)
  cleanup:
    needs: content-generation
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: ì„ì‹œ íŒŒì¼ ì •ë¦¬
        run: |
          echo "ğŸ§¹ ì •ë¦¬ ì‘ì—… ìˆ˜í–‰ ì¤‘..."
          # í•„ìš”ì‹œ ì„ì‹œ íŒŒì¼ì´ë‚˜ ìºì‹œ ì •ë¦¬
          echo "âœ… ì •ë¦¬ ì™„ë£Œ"