name: Test Content Generation

on:
  workflow_dispatch:
    inputs:
      test_type:
        description: 'í…ŒìŠ¤íŠ¸í•  ë‹¨ê³„ ì„ íƒ'
        required: true
        default: 'all'
        type: choice
        options:
          - 'all'
          - 'keywords'
          - 'crawling'
          - 'generation'
      debug_mode:
        description: 'ë””ë²„ê·¸ ëª¨ë“œ í™œì„±í™”'
        required: false
        default: false
        type: boolean

env:
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
  GOOGLE_TRENDS_API_KEY: ${{ secrets.GOOGLE_TRENDS_API_KEY }}
  NEWS_API_KEY: ${{ secrets.NEWS_API_KEY }}
  GNEWS_API_KEY: ${{ secrets.GNEWS_API_KEY }}
  REDDIT_CLIENT_ID: ${{ secrets.REDDIT_CLIENT_ID }}
  REDDIT_CLIENT_SECRET: ${{ secrets.REDDIT_CLIENT_SECRET }}
  NODE_ENV: development

jobs:
  test-generation:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Node.js í™˜ê²½ ì„¤ì •  
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci --silent

      - name: ë””ë²„ê·¸ ì •ë³´ ì¶œë ¥
        if: ${{ inputs.debug_mode }}
        run: |
          echo "=== ë””ë²„ê·¸ ëª¨ë“œ í™œì„±í™” ==="
          echo "í…ŒìŠ¤íŠ¸ íƒ€ì…: ${{ inputs.test_type }}"
          echo "Node.js ë²„ì „: $(node --version)"
          echo "ì‘ì—… ë””ë ‰í† ë¦¬: $(pwd)"
          echo "íŒŒì¼ ëª©ë¡:"
          ls -la scripts/
          echo "í™˜ê²½ë³€ìˆ˜ í™•ì¸:"
          [ -n "$OPENAI_API_KEY" ] && echo "âœ… OpenAI API í‚¤ ìˆìŒ" || echo "âŒ OpenAI API í‚¤ ì—†ìŒ"

      - name: í‚¤ì›Œë“œ ìˆ˜ì§‘ í…ŒìŠ¤íŠ¸
        if: ${{ inputs.test_type == 'all' || inputs.test_type == 'keywords' }}
        run: |
          echo "ğŸ” í‚¤ì›Œë“œ ìˆ˜ì§‘ í…ŒìŠ¤íŠ¸ ì‹œì‘..."
          node scripts/collect-keywords-refactored.js
          
          if [ -f "config/keywords-today.json" ]; then
            echo "âœ… í‚¤ì›Œë“œ ìˆ˜ì§‘ ì„±ê³µ"
            cat config/keywords-today.json | jq '.finalKeywords[0:3]' || true
          else
            echo "âŒ í‚¤ì›Œë“œ ìˆ˜ì§‘ ì‹¤íŒ¨"
          fi

      - name: ì½˜í…ì¸  í¬ë¡¤ë§ í…ŒìŠ¤íŠ¸
        if: ${{ inputs.test_type == 'all' || inputs.test_type == 'crawling' }}
        run: |
          echo "ğŸ•·ï¸ ì½˜í…ì¸  í¬ë¡¤ë§ í…ŒìŠ¤íŠ¸ ì‹œì‘..."
          node scripts/crawl-content-refactored.js
          
          if [ -f "config/content-data.json" ]; then
            echo "âœ… í¬ë¡¤ë§ ì„±ê³µ"
            cat config/content-data.json | jq '.crawlResults' || true
          else
            echo "âŒ í¬ë¡¤ë§ ì‹¤íŒ¨"
          fi

      - name: í¬ìŠ¤íŠ¸ ìƒì„± í…ŒìŠ¤íŠ¸
        if: ${{ inputs.test_type == 'all' || inputs.test_type == 'generation' }}
        run: |
          echo "âœï¸ í¬ìŠ¤íŠ¸ ìƒì„± í…ŒìŠ¤íŠ¸ ì‹œì‘..."
          node scripts/generate-post-refactored.js
          
          if [ -d "content/posts" ] && [ "$(ls -A content/posts)" ]; then
            echo "âœ… í¬ìŠ¤íŠ¸ ìƒì„± ì„±ê³µ"
            echo "ìƒì„±ëœ íŒŒì¼:"
            ls -la content/posts/
          else
            echo "âŒ í¬ìŠ¤íŠ¸ ìƒì„± ì‹¤íŒ¨"
          fi

      - name: í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½
        if: always()
        run: |
          echo "
          ## ğŸ§ª í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½
          
          **í…ŒìŠ¤íŠ¸ íƒ€ì…**: ${{ inputs.test_type }}
          **ì‹¤í–‰ ì‹œê°„**: $(date)
          **ë””ë²„ê·¸ ëª¨ë“œ**: ${{ inputs.debug_mode }}
          
          **íŒŒì¼ í˜„í™©**:
          - í‚¤ì›Œë“œ íŒŒì¼: $([ -f 'config/keywords-today.json' ] && echo 'âœ…' || echo 'âŒ')
          - ì½˜í…ì¸  íŒŒì¼: $([ -f 'config/content-data.json' ] && echo 'âœ…' || echo 'âŒ')  
          - ìƒì„±ëœ í¬ìŠ¤íŠ¸: $(ls content/posts/*.md 2>/dev/null | wc -l || echo '0')ê°œ
          
          **ë‹¤ìŒ ë‹¨ê³„**: 
          - ì‹¤ì œ API í‚¤ ì„¤ì • í›„ í”„ë¡œë•ì…˜ í…ŒìŠ¤íŠ¸
          - ì›Œí¬í”Œë¡œìš° ìŠ¤ì¼€ì¤„ë§ í™œì„±í™”
          "

      - name: í…ŒìŠ¤íŠ¸ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ inputs.test_type }}-${{ github.run_number }}
          path: |
            config/*.json
            content/posts/*.md
            *.log
          retention-days: 7